---
title: Translate viral load and PCR efficiency to test sensitivity at different dilutions
---

The RT-qPCR process leads to an exponential growth phase of the viral load, such that after some number of cycles $n$, the viral load $R_n$ will be a function of the efficiency of the reaction $E$, the dilution factor and the starting viral load in the sample $R_0$:

$$
R_n = \frac{R_0}{D}(1 + E)^n
$$

Let the probability of a positive case being detected be 0.98 for an undiluted sample, and 0.8 for a 10x diluted sample. Allow up to $C_T = 35$ cycles to reach some fluourescence detection threshold $R_{C_T}. Let $R_0$ be distributed in the population such that

$$
R_0 \sim 10^{U(0, 3)}
$$

and assume that efficiency is some distribution between 0.65 and 0.9 e.g.

$$
E ~ \sim Beta(\alpha, \beta) \times (0.9 - 0.65) + 0.65
$$

We need to find some distributions of $R_0$ and $E$ that will result in a sensitivity of 0.98 at $D=1$ and 0.8 at $D=0.8$

Simulate some values of $E$ and $R_0$

```{r}
library(scales)
library(dplyr)
n <- 10000
R0 <- 10^runif(n, 0, 3)
E <- rbeta(n, 2, 5) %>% rescale(., to=c(0.65, 0.9))
hist(R0)
hist(E)
```

Calculate the $R_{C_T}$ values for different dilutions

```{r}
R35_1 <- R0 * (1 + E)^35
R35_10 <- R0/10 * (1 + E)^35
R35_30 <- R0/30 * (1 + E)^35
```

Are the sensitivities at the different dilutions concordant?

```{r}
(quantile(log(R35_1), 0.02) - quantile(log(R35_10), 0.2))^2
```

Quite similar. What sort of dilution curve does this give us?

```{r}
D <- seq(1,30)
Rct <- mean(c(
	quantile(log(R35_1), 0.02), 
	quantile(log(R35_10), 0.2)
))
dat <- tibble(
	D=D, 
	sensitivity=sapply(D, function(x) 
	{
		sum(log(R0/x * (1 + E)^35) > Rct)/n
	})
)
plot(sensitivity ~ D, dat)
```

Use optimisation to find parameters that will give concordant sensitivities at D = 1 and 10


```{r}
fn <- function(param, R0)
{
	n <- length(R0)
	E <- rbeta(n, param[1], param[2]) * (0.9-0.65) + 0.65
	R35_1 <- R0 * (1 + E)^35
	R35_10 <- R0/10 * (1 + E)^35
	q1 <- quantile(log(R35_1), 0.02)
	q10 <- quantile(log(R35_10), 0.2)
	return((q1 - q10)^2)
}
fn(c(2,5), R0)

n <- 100000
R0 <- 10^runif(n, 0, 3)
o <- optim(par = c(2, 5), fn=fn, R0=R0)
o
```

Now that we have parameter values for the distribution of $E$ we can look at what the dilution curve looks like

```{r}
D <- seq(1,100)
E <- rbeta(n, o$par[1], o$par[2]) * (0.9-0.65) + 0.65
Rct <- quantile(log(R0 * (1 + E)^35), 0.02)
dat <- tibble(
	D=D, 
	sensitivity=sapply(D, function(x) 
	{
		sum(log(R0/x * (1 + E)^35) > Rct)/n
	})
)
plot(sensitivity ~ D, dat)
```

